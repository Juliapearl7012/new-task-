<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab.js Excel Link Experiment</title>
    <script src="https://cdn.jsdelivr.net/npm/lab.js@latest/dist/lab.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        .content {
            text-align: center;
            font-size: 3em;
            font-weight: bold;
        }

        #loading-message {
            font-size: 1.5em;
            color: #555;
            text-align: center;
        }

        /* Styling for the error message to make it stand out */
        .error-message-container {
            padding: 20px;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            background-color: #fcecec;
            max-width: 600px;
            margin: 20px;
        }

        .error-message-container h1 {
            color: #c0392b;
        }
    </style>
</head>
<body>
    <!-- 
        NOTE: This experiment cannot be run successfully in the Canvas preview
        or by opening the index.html file directly from your computer.

        This is because the browser's security settings prevent a local file
        from fetching another local file (like 'words.csv'). The error you
        are seeing is a direct result of this restriction.

        To see the working experiment, you MUST visit the live GitHub Pages URL
        that was successfully deployed to the web.
    -->
    <div id="app">
        <div id="loading-message">Loading experiment data from words.csv...</div>
    </div>

    <script>
        (async function() {
            // =========================================================================
            //  STEP 1: FETCH AND PARSE THE CSV DATA (WITH ENHANCED ERROR LOGGING)
            // =========================================================================
            let experimentData = [];
            const appElement = document.getElementById('app');

            try {
                // The code has been reverted to a standard fetch call, which is the most reliable way
                // to load a file from the same directory when hosted on a live server.
                const response = await fetch('words.csv');

                if (!response.ok) {
                    console.error('Fetch response not OK:', {
                        status: response.status,
                        statusText: response.statusText,
                        url: response.url
                    });
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                console.log('CSV file fetched successfully.');
                console.log('CSV content:', csvText.substring(0, 100) + '...'); // Log a preview of the content

                // Use the correct Lab.js utility function to parse the CSV string.
                experimentData = lab.util.data.fromCsv(csvText);
                console.log('CSV data parsed successfully.');
                console.log('Parsed data:', experimentData);

                // Check if the data is actually populated
                if (experimentData.length === 0) {
                    throw new Error('CSV file is empty or parsing failed to produce any data.');
                }

            } catch (error) {
                console.error('Failed to load or parse CSV file:', error);
                
                // Display a more detailed and user-friendly error message on the page
                appElement.innerHTML = `
                    <div class="error-message-container">
                        <h1>Error: Could not load data from 'words.csv'.</h1>
                        <p>This is likely due to one of the following reasons:</p>
                        <ul>
                            <li>The file 'words.csv' is missing or has a typo in its name.</li>
                            <li>The file is empty or not in a valid CSV format.</li>
                            <li>You are running the file from your computer's local drive, not from a web server.</li>
                        </ul>
                        <p>For more specific information, please open your browser's developer console.</p>
                    </div>
                `;
                return; // Stop the script if data loading fails.
            }

            // =========================================================================
            //  STEP 2: CREATE THE EXPERIMENT COMPONENTS
            // =========================================================================
            const wordLoop = new lab.flow.Loop({
                template: new lab.html.Screen({
                    title: 'Word Presentation',
                    content: '<h1>${ this.state.Word }</h1>',
                    timeout: 45000,
                    responses: {
                        'keydown(any)': 'advance'
                    }
                }),
                datacomponent: 'word_loop',
                templateParameters: experimentData
            });

            const thankYouScreen = new lab.html.Screen({
                title: 'End of Experiment',
                content: '<h1>Thank you!</h1><p>The experiment is now complete.</p>',
                timeout: 5000
            });

            // =========================================================================
            //  STEP 3: ASSEMBLE AND START THE EXPERIMENT
            // =========================================================================
            const mainSequence = new lab.flow.Sequence({
                datacomponent: 'main_sequence',
                content: [
                    wordLoop,
                    thankYouScreen
                ]
            });

            const experiment = new lab.core.Experiment({
                'content': mainSequence
            });
            
            // Hook the experiment to the 'app' div in the HTML body.
            appElement.innerHTML = ''; // Clear the loading message
            experiment.run(appElement);
        })();
    </script>
</body>
</html>
